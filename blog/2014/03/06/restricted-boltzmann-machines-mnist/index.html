<!DOCTYPE html>
<html lang="ja-jp">
<head>
<meta charset="utf-8">
<meta name="generator" content="Hugo 0.70.0" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,700" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/github.min.css">
<link rel="stylesheet" href="/css/normalize.css">
<link rel="stylesheet" href="/css/skeleton.css">
<link rel="stylesheet" href="/css/custom.css">
<link rel="alternate" href="/index.xml" type="application/rss+xml" title="LESS IS MORE">
<link rel="shortcut icon" href="/favicon.png" type="image/x-icon" />
<title>Restricted Boltzmann Machines with MNIST - LESS IS MORE</title>
</head>
<body>

<div class="container">

	<header role="banner">
		<div class="header-logo">
			<a href="/"><img src="/images/r9y9.jpg" width="70" height="70"></a>
		</div>
		
	</header>


	<main role="main">
		<article itemscope itemtype="https://schema.org/BlogPosting">
			<h1 class="entry-title" itemprop="headline">Restricted Boltzmann Machines with MNIST</h1>
			<span class="entry-meta"><time itemprop="datePublished" datetime="2014-03-06">March 06, 2014</time></span>
			<section itemprop="entry-text">
				

<div align="center"><img src="/images/RBM_mnist_Hidden_500_layers.png "RBM training result on MNIST handwritten digit dataset. Each image represents a filter learned by RBM."" class="image"></div>

<p>ディープ某を使った研究を再現してみたくて、最近某ニューラルネットに手を出し始めた。で、手始めにRestricted Boltzmann Machinesを実装してみたので、</p>

<ul>
<li>MNISTを使って学習した結果の重み（22*22=484個）を貼っとく（↑）</li>
<li>得た知見をまとめとく</li>
<li>Goのコード貼っとく</li>
</ul>

<p>ってな感じで書いておく</p>

<p>(本当はRBMについて自分なりの解釈を書こうと思ったのだけど、それはまた今度)</p>

<h2 id="実験条件">実験条件</h2>

<p>データベースはmnist。手書き数字認識で有名なアレ。学習の条件は、</p>

<ul>
<li>隠れ層のユニット数: 500</li>
<li>mini-batch size: 20</li>
<li>iterationの回数: 15</li>
</ul>

<h2 id="対数尤度の変化">対数尤度の変化</h2>

<div align="center"><img src="/images/RBM_mnist_Hidden_500_log_likelihood.png "Pseudo log-likelihood on mnist databae."" class="image"></div>

<p>以下グラフに表示している生データ</p>
<pre><code>0 -196.59046099622128
1 -70.31708616742365
2 -65.29499371647965
3 -62.37983267378022
4 -61.5359019358253
5 -60.917772257650164
6 -59.64207778426757
7 -59.42201674307857
8 -59.18497336138633
9 -58.277168243126305
10 -58.36279288392401
11 -58.57805165724595
12 -57.71043215987184
13 -58.17783142034138
14 -57.53629129936344</code></pre>
<p>尤度上がると安心する。厳密に対数尤度を計算することは難しいので、<a href="http://deeplearning.net/tutorial/rbm.html">Restricted Boltzmann Machines (RBM) | DeepLearning Tutorial</a> にある擬似尤度を参考にした</p>

<h2 id="学習時間">学習時間</h2>

<p>うちのcore2duoのPCで4時間弱だった気がする（うろ覚え</p>

<p>隠れ層のユニット数100だと、40分ほどだった</p>

<h2 id="知見">知見</h2>

<p>今の所、試行錯誤して自分が得た知見は、</p>

<ul>
<li>sample by sampleのSGDよりmini-batch SGDの方が安定して尤度上がる</li>
<li>mini-batch sizeを大きくしすぎると学習が進まない。20くらいがちょうど良かった</li>
<li>k-CD のkを大きくしてもさほど学習結果変わらない（計算コストはけっこう増すけど）</li>
<li>persistent CDを使ってもあまりよくならない（計算コストはけっこう増すけど）</li>
<li>やっぱ1-CDで十分だった</li>
<li>データの正規化方法によって結構結果も変わる。ノイズを足すかどうか、とか</li>
<li>学習率超重要すぎわろた。今回の場合は0.1くらいかちょうど良かった</li>
<li>隠れ層のユニット数が大きいほど学習が上手く行けばと尤度は上がる(?)</li>
</ul>

<p>まぁだいたい <a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">A Practical Guide to Training Restricted Boltzmann Machines (PDF)</a> に書いてあるけど、実際に肌で感じて理解した。persistent CDはもうちょっと成果出て欲しい。データ変えると成果出るんかな？</p>

<h2 id="コード">コード</h2>

<p>コアの部分だけ、一応</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">rbm</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;encoding/json&#34;</span>
	<span style="color:#e6db74">&#34;errors&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/r9y9/nn&#34;</span> <span style="color:#75715e">// sigmoid, matrix
</span><span style="color:#75715e"></span>	<span style="color:#e6db74">&#34;math&#34;</span>
	<span style="color:#e6db74">&#34;math/rand&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#75715e">// References:
</span><span style="color:#75715e">// [1] G. Hinton, &#34;A Practical Guide to Training Restricted Boltzmann Machines&#34;,
</span><span style="color:#75715e">// UTML TR 2010-003.
</span><span style="color:#75715e">// url: http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf
</span><span style="color:#75715e">//
</span><span style="color:#75715e">// [2] A. Fischer and C. Igel. &#34;An introduction to restricted Boltzmann machines&#34;,
</span><span style="color:#75715e">// Proc. of the 17th Iberoamerican Congress on Pattern Recognition (CIARP),
</span><span style="color:#75715e">// Volume 7441 of LNCS, pages 14–36. Springer, 2012
</span><span style="color:#75715e">// url: http://image.diku.dk/igel/paper/AItRBM-proof.pdf
</span><span style="color:#75715e">//
</span><span style="color:#75715e">// [3] Restricted Boltzmann Machines (RBM),  DeepLearning tutorial
</span><span style="color:#75715e">// url: http://deeplearning.net/tutorial/rbm.html
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// Notes about implementation:
</span><span style="color:#75715e">// Notation used in this code basically follows [2].
</span><span style="color:#75715e">// e.g. W for weight, B for bias of visible layer, C for bias of hidden layer.
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// Graphical representation of Restricted Boltzmann Machines (RBM).
</span><span style="color:#75715e">//
</span><span style="color:#75715e">//     ○ ○ .... ○  h(hidden layer), c(bias)
</span><span style="color:#75715e">//     /\ /\ /    /\
</span><span style="color:#75715e">//    ○ ○ ○ ... ○ v(visible layer), b(bias)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">RBM</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">W</span>               [][]<span style="color:#66d9ef">float64</span> <span style="color:#75715e">// Weight
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">B</span>               []<span style="color:#66d9ef">float64</span>   <span style="color:#75715e">// Bias of visible layer
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">C</span>               []<span style="color:#66d9ef">float64</span>   <span style="color:#75715e">// Bias of hidden layer
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">NumHiddenUnits</span>  <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">NumVisibleUnits</span> <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">Option</span>          <span style="color:#a6e22e">TrainingOption</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">TrainingOption</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">LearningRate</span>        <span style="color:#66d9ef">float64</span>
	<span style="color:#a6e22e">OrderOfGibbsSamping</span> <span style="color:#66d9ef">int</span> <span style="color:#75715e">// It is known that 1 is enough for many cases.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Epoches</span>             <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">MiniBatchSize</span>       <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">L2Regularization</span>    <span style="color:#66d9ef">bool</span>
	<span style="color:#a6e22e">RegularizationRate</span>  <span style="color:#66d9ef">float64</span>
}

<span style="color:#75715e">// NewRBM creates new RBM instance. It requires input data and number of
</span><span style="color:#75715e">// hidden units to initialize RBM.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewRBM</span>(<span style="color:#a6e22e">numVisibleUnits</span>, <span style="color:#a6e22e">numHiddenUnits</span> <span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">RBM</span> {
	<span style="color:#a6e22e">rbm</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">RBM</span>)
	<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Seed</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">UnixNano</span>())

	<span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">W</span> = <span style="color:#a6e22e">nn</span>.<span style="color:#a6e22e">MakeMatrix</span>(<span style="color:#a6e22e">numHiddenUnits</span>, <span style="color:#a6e22e">numVisibleUnits</span>)
	<span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">B</span> = make([]<span style="color:#66d9ef">float64</span>, <span style="color:#a6e22e">numVisibleUnits</span>)
	<span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">C</span> = make([]<span style="color:#66d9ef">float64</span>, <span style="color:#a6e22e">numHiddenUnits</span>)
	<span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumVisibleUnits</span> = <span style="color:#a6e22e">numVisibleUnits</span>
	<span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumHiddenUnits</span> = <span style="color:#a6e22e">numHiddenUnits</span>

	<span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">InitRBM</span>()
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">rbm</span>
}

<span style="color:#75715e">// NewRBMWithParameters returns RBM instance given RBM parameters.
</span><span style="color:#75715e">// This func will be used in Deep Belief Networks.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewRBMWithParameters</span>(<span style="color:#a6e22e">W</span> [][]<span style="color:#66d9ef">float64</span>, <span style="color:#a6e22e">B</span>, <span style="color:#a6e22e">C</span> []<span style="color:#66d9ef">float64</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">RBM</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">rbm</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">RBM</span>)

	<span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumVisibleUnits</span> = len(<span style="color:#a6e22e">B</span>)
	<span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumHiddenUnits</span> = len(<span style="color:#a6e22e">C</span>)

	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">W</span>) <span style="color:#f92672">!=</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumHiddenUnits</span> <span style="color:#f92672">||</span> len(<span style="color:#a6e22e">W</span>[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">!=</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumVisibleUnits</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;Shape of weight matrix is wrong.&#34;</span>)
	}

	<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Seed</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">UnixNano</span>())
	<span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">W</span> = <span style="color:#a6e22e">W</span>
	<span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">B</span> = <span style="color:#a6e22e">B</span>
	<span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">C</span> = <span style="color:#a6e22e">C</span>

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">rbm</span>, <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// LoadRBM loads RBM from a dump file and return its instatnce.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">LoadRBM</span>(<span style="color:#a6e22e">filename</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">RBM</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">file</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#a6e22e">filename</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Close</span>()

	<span style="color:#a6e22e">decoder</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">NewDecoder</span>(<span style="color:#a6e22e">file</span>)
	<span style="color:#a6e22e">rbm</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">RBM</span>{}
	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">decoder</span>.<span style="color:#a6e22e">Decode</span>(<span style="color:#a6e22e">rbm</span>)

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">rbm</span>, <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// Dump writes RBM parameters to file in json format.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rbm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RBM</span>) <span style="color:#a6e22e">Dump</span>(<span style="color:#a6e22e">filename</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">file</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">filename</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Close</span>()

	<span style="color:#a6e22e">encoder</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">NewEncoder</span>(<span style="color:#a6e22e">file</span>)
	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">encoder</span>.<span style="color:#a6e22e">Encode</span>(<span style="color:#a6e22e">rbm</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// Heuristic initialization of visible bias.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rbm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RBM</span>) <span style="color:#a6e22e">InitVisibleBiasUsingTrainingData</span>(<span style="color:#a6e22e">data</span> [][]<span style="color:#66d9ef">float64</span>) {
	<span style="color:#75715e">// Init B (bias of visible layer)
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">activeRateInVisibleLayer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">getActiveRateInVisibleLayer</span>(<span style="color:#a6e22e">data</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">j</span> &lt; <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumVisibleUnits</span>; <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">B</span>[<span style="color:#a6e22e">j</span>] = <span style="color:#a6e22e">math</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#a6e22e">activeRateInVisibleLayer</span>[<span style="color:#a6e22e">j</span>] <span style="color:#f92672">/</span> (<span style="color:#ae81ff">1.0</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">activeRateInVisibleLayer</span>[<span style="color:#a6e22e">j</span>]))
	}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rbm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RBM</span>) <span style="color:#a6e22e">getActiveRateInVisibleLayer</span>(<span style="color:#a6e22e">data</span> [][]<span style="color:#66d9ef">float64</span>) []<span style="color:#66d9ef">float64</span> {
	<span style="color:#a6e22e">rate</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">float64</span>, <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumVisibleUnits</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">sample</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">data</span> {
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">j</span> &lt; <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumVisibleUnits</span>; <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span> {
			<span style="color:#a6e22e">rate</span>[<span style="color:#a6e22e">j</span>] <span style="color:#f92672">+=</span> <span style="color:#a6e22e">sample</span>[<span style="color:#a6e22e">j</span>]
		}
	}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">rate</span> {
		<span style="color:#a6e22e">rate</span>[<span style="color:#a6e22e">j</span>] <span style="color:#f92672">/=</span> float64(len(<span style="color:#a6e22e">data</span>))
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">rate</span>
}

<span style="color:#75715e">// InitRBM performes a heuristic parameter initialization.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rbm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RBM</span>) <span style="color:#a6e22e">InitRBM</span>() {
	<span style="color:#75715e">// Init W
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumHiddenUnits</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">j</span> &lt; <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumVisibleUnits</span>; <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span> {
			<span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">W</span>[<span style="color:#a6e22e">i</span>][<span style="color:#a6e22e">j</span>] = <span style="color:#ae81ff">0.01</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">NormFloat64</span>()
		}
	}

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">j</span> &lt; <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumVisibleUnits</span>; <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">B</span>[<span style="color:#a6e22e">j</span>] = <span style="color:#ae81ff">0.0</span>
	}

	<span style="color:#75715e">// Init C (bias of hidden layer)
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumHiddenUnits</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">C</span>[<span style="color:#a6e22e">i</span>] = <span style="color:#ae81ff">0.0</span>
	}
}

<span style="color:#75715e">// P_H_Given_V returns the conditinal probability of a hidden unit given a set of visible units.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rbm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RBM</span>) <span style="color:#a6e22e">P_H_Given_V</span>(<span style="color:#a6e22e">hiddenIndex</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">v</span> []<span style="color:#66d9ef">float64</span>) <span style="color:#66d9ef">float64</span> {
	<span style="color:#a6e22e">sum</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0.0</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">j</span> &lt; <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumVisibleUnits</span>; <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">sum</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">W</span>[<span style="color:#a6e22e">hiddenIndex</span>][<span style="color:#a6e22e">j</span>] <span style="color:#f92672">*</span> <span style="color:#a6e22e">v</span>[<span style="color:#a6e22e">j</span>]
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">nn</span>.<span style="color:#a6e22e">Sigmoid</span>(<span style="color:#a6e22e">sum</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">C</span>[<span style="color:#a6e22e">hiddenIndex</span>])
}

<span style="color:#75715e">// P_V_Given_H returns the conditinal probability of a visible unit given a set of hidden units.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rbm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RBM</span>) <span style="color:#a6e22e">P_V_Given_H</span>(<span style="color:#a6e22e">visibleIndex</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">h</span> []<span style="color:#66d9ef">float64</span>) <span style="color:#66d9ef">float64</span> {
	<span style="color:#a6e22e">sum</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0.0</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumHiddenUnits</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">sum</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">W</span>[<span style="color:#a6e22e">i</span>][<span style="color:#a6e22e">visibleIndex</span>] <span style="color:#f92672">*</span> <span style="color:#a6e22e">h</span>[<span style="color:#a6e22e">i</span>]
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">nn</span>.<span style="color:#a6e22e">Sigmoid</span>(<span style="color:#a6e22e">sum</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">B</span>[<span style="color:#a6e22e">visibleIndex</span>])
}

<span style="color:#75715e">// GibbsSampling performs k-Gibbs sampling algorithm,
</span><span style="color:#75715e">// where k is the number of iterations in gibbs sampling.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rbm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RBM</span>) <span style="color:#a6e22e">GibbsSampling</span>(<span style="color:#a6e22e">v</span> []<span style="color:#66d9ef">float64</span>, <span style="color:#a6e22e">k</span> <span style="color:#66d9ef">int</span>) []<span style="color:#66d9ef">float64</span> {
	<span style="color:#75715e">// Initial value is set to input
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">vUsedInSamping</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">float64</span>, len(<span style="color:#a6e22e">v</span>))
	copy(<span style="color:#a6e22e">vUsedInSamping</span>, <span style="color:#a6e22e">v</span>)

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">t</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">t</span> &lt; <span style="color:#a6e22e">k</span>; <span style="color:#a6e22e">t</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">sampledH</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">float64</span>, <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumHiddenUnits</span>)
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumHiddenUnits</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
			<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">P_H_Given_V</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">vUsedInSamping</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span> &gt; <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Float64</span>() {
				<span style="color:#a6e22e">sampledH</span>[<span style="color:#a6e22e">i</span>] = <span style="color:#ae81ff">1.0</span>
			} <span style="color:#66d9ef">else</span> {
				<span style="color:#a6e22e">sampledH</span>[<span style="color:#a6e22e">i</span>] = <span style="color:#ae81ff">0.0</span>
			}
		}
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">j</span> &lt; <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumVisibleUnits</span>; <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span> {
			<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">P_V_Given_H</span>(<span style="color:#a6e22e">j</span>, <span style="color:#a6e22e">sampledH</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span> &gt; <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Float64</span>() {
				<span style="color:#a6e22e">vUsedInSamping</span>[<span style="color:#a6e22e">j</span>] = <span style="color:#ae81ff">1.0</span>
			} <span style="color:#66d9ef">else</span> {
				<span style="color:#a6e22e">vUsedInSamping</span>[<span style="color:#a6e22e">j</span>] = <span style="color:#ae81ff">0.0</span>
			}
		}
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">vUsedInSamping</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">flip</span>(<span style="color:#a6e22e">x</span> []<span style="color:#66d9ef">float64</span>, <span style="color:#a6e22e">bit</span> <span style="color:#66d9ef">int</span>) []<span style="color:#66d9ef">float64</span> {
	<span style="color:#a6e22e">y</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">float64</span>, len(<span style="color:#a6e22e">x</span>))
	copy(<span style="color:#a6e22e">y</span>, <span style="color:#a6e22e">x</span>)
	<span style="color:#a6e22e">y</span>[<span style="color:#a6e22e">bit</span>] = <span style="color:#ae81ff">1.0</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">x</span>[<span style="color:#a6e22e">bit</span>]
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">y</span>
}

<span style="color:#75715e">// FreeEnergy returns F(v), the free energy of RBM given a visible vector v.
</span><span style="color:#75715e">// refs: eq. (25) in [1].
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rbm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RBM</span>) <span style="color:#a6e22e">FreeEnergy</span>(<span style="color:#a6e22e">v</span> []<span style="color:#66d9ef">float64</span>) <span style="color:#66d9ef">float64</span> {
	<span style="color:#a6e22e">energy</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0.0</span>

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">j</span> &lt; <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumVisibleUnits</span>; <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">energy</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">B</span>[<span style="color:#a6e22e">j</span>] <span style="color:#f92672">*</span> <span style="color:#a6e22e">v</span>[<span style="color:#a6e22e">j</span>]
	}

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumHiddenUnits</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">sum</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">C</span>[<span style="color:#a6e22e">i</span>]
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">j</span> &lt; <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumVisibleUnits</span>; <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span> {
			<span style="color:#a6e22e">sum</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">W</span>[<span style="color:#a6e22e">i</span>][<span style="color:#a6e22e">j</span>] <span style="color:#f92672">*</span> <span style="color:#a6e22e">v</span>[<span style="color:#a6e22e">j</span>]
		}
		<span style="color:#a6e22e">energy</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">math</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">math</span>.<span style="color:#a6e22e">Exp</span>(<span style="color:#a6e22e">sum</span>))
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">energy</span>
}

<span style="color:#75715e">// PseudoLogLikelihood returns pseudo log-likelihood for a given input data.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rbm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RBM</span>) <span style="color:#a6e22e">PseudoLogLikelihood</span>(<span style="color:#a6e22e">v</span> []<span style="color:#66d9ef">float64</span>) <span style="color:#66d9ef">float64</span> {
	<span style="color:#a6e22e">bitIndex</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Int</span>() <span style="color:#f92672">%</span> len(<span style="color:#a6e22e">v</span>)
	<span style="color:#a6e22e">fe</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">FreeEnergy</span>(<span style="color:#a6e22e">v</span>)
	<span style="color:#a6e22e">feFlip</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">FreeEnergy</span>(<span style="color:#a6e22e">flip</span>(<span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">bitIndex</span>))
	<span style="color:#a6e22e">cost</span> <span style="color:#f92672">:=</span> float64(<span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumVisibleUnits</span>) <span style="color:#f92672">*</span> <span style="color:#a6e22e">math</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#a6e22e">nn</span>.<span style="color:#a6e22e">Sigmoid</span>(<span style="color:#a6e22e">feFlip</span><span style="color:#f92672">-</span><span style="color:#a6e22e">fe</span>))
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">cost</span>
}

<span style="color:#75715e">// PseudoLogLikelihood returns pseudo log-likelihood for a given dataset (or mini-batch).
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rbm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RBM</span>) <span style="color:#a6e22e">PseudoLogLikelihoodForAllData</span>(<span style="color:#a6e22e">data</span> [][]<span style="color:#66d9ef">float64</span>) <span style="color:#66d9ef">float64</span> {
	<span style="color:#a6e22e">sum</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0.0</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">data</span> {
		<span style="color:#a6e22e">sum</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">PseudoLogLikelihood</span>(<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">i</span>])
	}
	<span style="color:#a6e22e">cost</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sum</span> <span style="color:#f92672">/</span> float64(len(<span style="color:#a6e22e">data</span>))
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">cost</span>
}

<span style="color:#75715e">// ComputeGradient returns gradients of RBM parameters for a given (mini-batch) dataset.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rbm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RBM</span>) <span style="color:#a6e22e">ComputeGradient</span>(<span style="color:#a6e22e">data</span> [][]<span style="color:#66d9ef">float64</span>) ([][]<span style="color:#66d9ef">float64</span>, []<span style="color:#66d9ef">float64</span>, []<span style="color:#66d9ef">float64</span>) {
	<span style="color:#a6e22e">gradW</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">nn</span>.<span style="color:#a6e22e">MakeMatrix</span>(<span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumHiddenUnits</span>, <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumVisibleUnits</span>)
	<span style="color:#a6e22e">gradB</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">float64</span>, <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumVisibleUnits</span>)
	<span style="color:#a6e22e">gradC</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">float64</span>, <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumHiddenUnits</span>)

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">data</span> {
		<span style="color:#75715e">// Gibbs Sampling
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">gibbsStart</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>
		<span style="color:#a6e22e">vAfterSamping</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">GibbsSampling</span>(<span style="color:#a6e22e">gibbsStart</span>, <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">Option</span>.<span style="color:#a6e22e">OrderOfGibbsSamping</span>)

		<span style="color:#75715e">// pre-computation that is used in gradient computation
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">p_h_given_v1</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">float64</span>, <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumHiddenUnits</span>)
		<span style="color:#a6e22e">p_h_given_v2</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">float64</span>, <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumHiddenUnits</span>)
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumHiddenUnits</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
			<span style="color:#a6e22e">p_h_given_v1</span>[<span style="color:#a6e22e">i</span>] = <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">P_H_Given_V</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">v</span>)
			<span style="color:#a6e22e">p_h_given_v2</span>[<span style="color:#a6e22e">i</span>] = <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">P_H_Given_V</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">vAfterSamping</span>)
		}

		<span style="color:#75715e">// Gompute gradient of W
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumHiddenUnits</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
			<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">j</span> &lt; <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumVisibleUnits</span>; <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span> {
				<span style="color:#a6e22e">gradW</span>[<span style="color:#a6e22e">i</span>][<span style="color:#a6e22e">j</span>] <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p_h_given_v1</span>[<span style="color:#a6e22e">i</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">v</span>[<span style="color:#a6e22e">j</span>] <span style="color:#f92672">-</span> <span style="color:#a6e22e">p_h_given_v2</span>[<span style="color:#a6e22e">i</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">vAfterSamping</span>[<span style="color:#a6e22e">j</span>]
			}
		}

		<span style="color:#75715e">// Gompute gradient of B
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">j</span> &lt; <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumVisibleUnits</span>; <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span> {
			<span style="color:#a6e22e">gradB</span>[<span style="color:#a6e22e">j</span>] <span style="color:#f92672">+=</span> <span style="color:#a6e22e">v</span>[<span style="color:#a6e22e">j</span>] <span style="color:#f92672">-</span> <span style="color:#a6e22e">vAfterSamping</span>[<span style="color:#a6e22e">j</span>]
		}

		<span style="color:#75715e">// Gompute gradient of C
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumHiddenUnits</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
			<span style="color:#a6e22e">gradC</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">+=</span> <span style="color:#a6e22e">p_h_given_v1</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">-</span> <span style="color:#a6e22e">p_h_given_v2</span>[<span style="color:#a6e22e">i</span>]
		}
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">gradW</span>, <span style="color:#a6e22e">gradB</span>, <span style="color:#a6e22e">gradC</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rbm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RBM</span>) <span style="color:#a6e22e">ParseTrainingOption</span>(<span style="color:#a6e22e">option</span> <span style="color:#a6e22e">TrainingOption</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">Option</span> = <span style="color:#a6e22e">option</span>

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">Option</span>.<span style="color:#a6e22e">MiniBatchSize</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;Number of mini-batchs must be larger than zero.&#34;</span>)
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">Option</span>.<span style="color:#a6e22e">Epoches</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;Epoches must be larger than zero.&#34;</span>)
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">Option</span>.<span style="color:#a6e22e">OrderOfGibbsSamping</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;Order of Gibbs sampling must be larger than zero.&#34;</span>)
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">Option</span>.<span style="color:#a6e22e">LearningRate</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;Learning rate must be specified to train RBMs.&#34;</span>)
	}

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// Train performs Contrastive divergense learning algorithm to train RBM.
</span><span style="color:#75715e">// The alrogithm is basedd on (mini-batch) Stochastic Gradient Ascent.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rbm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RBM</span>) <span style="color:#a6e22e">Train</span>(<span style="color:#a6e22e">data</span> [][]<span style="color:#66d9ef">float64</span>, <span style="color:#a6e22e">option</span> <span style="color:#a6e22e">TrainingOption</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">ParseTrainingOption</span>(<span style="color:#a6e22e">option</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">numMiniBatches</span> <span style="color:#f92672">:=</span> len(<span style="color:#a6e22e">data</span>) <span style="color:#f92672">/</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">Option</span>.<span style="color:#a6e22e">MiniBatchSize</span>

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">epoch</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">epoch</span> &lt; <span style="color:#a6e22e">option</span>.<span style="color:#a6e22e">Epoches</span>; <span style="color:#a6e22e">epoch</span><span style="color:#f92672">++</span> {
		<span style="color:#75715e">// Monitoring
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">epoch</span>, <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">PseudoLogLikelihoodForAllData</span>(<span style="color:#a6e22e">data</span>))

		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">m</span> &lt; <span style="color:#a6e22e">numMiniBatches</span>; <span style="color:#a6e22e">m</span><span style="color:#f92672">++</span> {
			<span style="color:#75715e">// Compute Gradient
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">batch</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">m</span><span style="color:#f92672">*</span><span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">Option</span>.<span style="color:#a6e22e">MiniBatchSize</span> : (<span style="color:#a6e22e">m</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">*</span><span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">Option</span>.<span style="color:#a6e22e">MiniBatchSize</span>]
			<span style="color:#a6e22e">gradW</span>, <span style="color:#a6e22e">gradB</span>, <span style="color:#a6e22e">gradC</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">ComputeGradient</span>(<span style="color:#a6e22e">batch</span>)

			<span style="color:#75715e">// Update W
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumHiddenUnits</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
				<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">j</span> &lt; <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumVisibleUnits</span>; <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span> {
					<span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">W</span>[<span style="color:#a6e22e">i</span>][<span style="color:#a6e22e">j</span>] <span style="color:#f92672">+=</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">Option</span>.<span style="color:#a6e22e">LearningRate</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">gradW</span>[<span style="color:#a6e22e">i</span>][<span style="color:#a6e22e">j</span>] <span style="color:#f92672">/</span> float64(<span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">Option</span>.<span style="color:#a6e22e">MiniBatchSize</span>)
					<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">Option</span>.<span style="color:#a6e22e">L2Regularization</span> {
						<span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">W</span>[<span style="color:#a6e22e">i</span>][<span style="color:#a6e22e">j</span>] <span style="color:#f92672">*=</span> (<span style="color:#ae81ff">1.0</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">Option</span>.<span style="color:#a6e22e">RegularizationRate</span>)
					}
				}
			}

			<span style="color:#75715e">// Update B
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">j</span> &lt; <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumVisibleUnits</span>; <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span> {
				<span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">B</span>[<span style="color:#a6e22e">j</span>] <span style="color:#f92672">+=</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">Option</span>.<span style="color:#a6e22e">LearningRate</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">gradB</span>[<span style="color:#a6e22e">j</span>] <span style="color:#f92672">/</span> float64(<span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">Option</span>.<span style="color:#a6e22e">MiniBatchSize</span>)
			}

			<span style="color:#75715e">// Update C
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">NumHiddenUnits</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
				<span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">C</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">+=</span> <span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">Option</span>.<span style="color:#a6e22e">LearningRate</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">gradC</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">/</span> float64(<span style="color:#a6e22e">rbm</span>.<span style="color:#a6e22e">Option</span>.<span style="color:#a6e22e">MiniBatchSize</span>)
			}
		}
	}

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}</code></pre></div>
<p>使い方とかは察して（どうせ誰も使わないはず</p>

<p>今は、通常のRBMのvisible layerを連続値に拡張した Gaussian Bernoulli RBMを学習しようとしてるんだけど、これがムズイ。実装ミスもあるかもだけど、局所解に落ちまくってる気がする。</p>

<p>Gaussian Bernoulli RBM、Deep Belief Networks, Deep Neural Networksについてはまた今度</p>

<p>2014/05/11
要望があったので、もろもろコードあげました
<a href="https://github.com/r9y9/nnet">https://github.com/r9y9/nnet</a></p>

<h2 id="参考資料">参考資料</h2>

<ul>
<li><a href="http://image.diku.dk/igel/paper/AItRBM-proof.pdf">An Introduction to Restricted Boltzmann Machines (PDF)</a></li>
<li><a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">A Practical Guide to Training Restricted Boltzmann Machines (PDF)</a></li>
<li><a href="http://mglab.blogspot.jp/2012/08/restricted-boltzmann-machine.html">Restricted Boltzmann Machineの学習手法についての簡単なまとめ | 映像奮闘記</a></li>
<li><a href="http://d.hatena.ne.jp/saket/20121212">ゆるふわ Restricted Boltzmann Machine | Risky Dune</a></li>
<li><a href="http://deeplearning.net/tutorial/rbm.html">Restricted Boltzmann Machines (RBM) | DeepLearning Tutorial</a></li>
<li><a href="http://imonad.com/rbm/restricted-boltzmann-machine/">Restricted Boltzmann Machine - Short Tutorial | iMonad</a>

<ul>
<li><a href="http://scikit-learn.org/stable/auto_examples/plot_rbm_logistic_classification.html">Restricted Boltzmann Machine features for digit classification | scikit-learn</a></li>
</ul></li>
</ul>

				
<div class="social">
    <div>
        <a href="https://twitter.com/share" class="twitter-share-button" data-via="r9y9" data-text="Restricted Boltzmann Machines with MNIST" data-related="r9y9">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    </div>
</div>


			</section>
		</article>
	</main>


	<footer role="contentinfo">
		<div class="hr"></div>
		<address>
			<div class="avatar-bottom">
				<a href="/">
					
					<img src="/images/r9y9.jpg">
					
				</a>
			</div>

		<div class="copyright">Copyright &copy;
			<a href="/about">Ryuichi YAMAMOTO</a> All rights reserved.

			<a href="https://github.com/r9y9">
				<span class="github">r9y9@Github</span>
			</a>
		</div>
		</address>
	</footer>

</div>

<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-44433856-1', 'auto');
	ga('send', 'pageview');
</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



<script type="text/x-mathjax-config">
     MathJax.Hub.Config({
         HTML: ["input/TeX","output/HTML-CSS"],
         TeX: {
                Macros: {
                         bm: ["\\boldsymbol{#1}", 1],
                         argmax: ["\\mathop{\\rm arg\\,max}\\limits"],
                         argmin: ["\\mathop{\\rm arg\\,min}\\limits"]},
                extensions: ["AMSmath.js","AMSsymbols.js"],
                equationNumbers: { autoNumber: "AMS" } },
         extensions: ["tex2jax.js"],
         jax: ["input/TeX","output/HTML-CSS"],
         tex2jax: { inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                    displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
                    processEscapes: true },
         "HTML-CSS": { availableFonts: ["TeX"],
                       linebreaks: { automatic: true } }
     });
 </script>

 <script type="text/x-mathjax-config">
     MathJax.Hub.Config({
       tex2jax: {
         skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
       }
     });
 </script>

 <script type="text/javascript" async
   src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML">
 </script>




</body>
</html>


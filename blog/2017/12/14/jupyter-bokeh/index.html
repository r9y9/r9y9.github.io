<!DOCTYPE html>
<html lang="ja-jp">
<head>
<meta charset="utf-8">
<meta name="generator" content="Hugo 0.70.0" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,700" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/github.min.css">
<link rel="stylesheet" href="/css/normalize.css">
<link rel="stylesheet" href="/css/skeleton.css">
<link rel="stylesheet" href="/css/custom.css">
<link rel="alternate" href="/index.xml" type="application/rss+xml" title="LESS IS MORE">
<link rel="shortcut icon" href="/favicon.png" type="image/x-icon" />
<title>ニューラルネットの学習過程の可視化を題材に、Jupyter &#43; Bokeh で動的な描画を行う方法の紹介 [Jupyter Advent Calendar 2017] - LESS IS MORE</title>
</head>
<body>

<div class="container">

	<header role="banner">
		<div class="header-logo">
			<a href="/"><img src="/images/r9y9.jpg" width="70" height="70"></a>
		</div>
		
	</header>


	<main role="main">
		<article itemscope itemtype="https://schema.org/BlogPosting">
			<h1 class="entry-title" itemprop="headline">ニューラルネットの学習過程の可視化を題材に、Jupyter &#43; Bokeh で動的な描画を行う方法の紹介 [Jupyter Advent Calendar 2017]</h1>
			<span class="entry-meta"><time itemprop="datePublished" datetime="2017-12-14">December 14, 2017</time></span>
			<section itemprop="entry-text">
				

<p>Line <a href="https://bokeh.pydata.org/en/latest/docs/reference/models/glyphs/line.html">https://bokeh.pydata.org/en/latest/docs/reference/models/glyphs/line.html</a></p>

<p><img src="/images/jupyter_with_bokeh_files/jupyter_with_bokeh_3_1.png" alt="png" /></p>

<p>VBar <a href="https://bokeh.pydata.org/en/latest/docs/reference/models/glyphs/vbar.html">https://bokeh.pydata.org/en/latest/docs/reference/models/glyphs/vbar.html</a></p>

<p><img src="/images/jupyter_with_bokeh_files/jupyter_with_bokeh_3_3.png" alt="png" /></p>

<p>HBar <a href="https://bokeh.pydata.org/en/latest/docs/reference/models/glyphs/hbar.html">https://bokeh.pydata.org/en/latest/docs/reference/models/glyphs/hbar.html</a></p>

<p><img src="/images/jupyter_with_bokeh_files/jupyter_with_bokeh_3_5.png" alt="png" /></p>

<p>ImageRGBA <a href="https://bokeh.pydata.org/en/latest/docs/reference/models/glyphs/image_rgba.html">https://bokeh.pydata.org/en/latest/docs/reference/models/glyphs/image_rgba.html</a></p>

<p><img src="/images/jupyter_with_bokeh_files/jupyter_with_bokeh_3_7.png" alt="png" /></p>

<p>ImageRGBA <a href="https://bokeh.pydata.org/en/latest/docs/reference/models/glyphs/image_rgba.html">https://bokeh.pydata.org/en/latest/docs/reference/models/glyphs/image_rgba.html</a></p>

<p><img src="/images/jupyter_with_bokeh_files/jupyter_with_bokeh_3_9.png" alt="png" /></p>

<h2 id="前置き">前置き</h2>

<p><a href="https://qiita.com/advent-calendar/2017/jupyter">Jupyter Advent Calendar 2017</a> 14日目の記事です。この記事は、Jupyter notebookで作成したものをnbconvertでmarkdownに変換し、手で少し修正して作りました。読み物としてはこの記事を、実行するにはノートブックの方を参照していただくのが良いかと思います。</p>

<ul>
<li><a href="https://gist.github.com/r9y9/d57e797c28f6cdc4e44264411c21b76f">ノートブック (gist)</a></li>
<li><a href="http://nbviewer.jupyter.org/gist/r9y9/d57e797c28f6cdc4e44264411c21b76f">nbviewer</a></li>
</ul>

<h2 id="概要">概要</h2>

<p>適当なニューラルネットの学習過程の可視化（ロス、正解率の遷移等）を題材にして、<a href="https://bokeh.pydata.org/en/latest/">Bokeh</a>を使って動的にグラフを更新していくことによる可視化の実用例を紹介します。このノートブックの冒頭に、最後まで実行すると得られるグラフ一覧をまとめました。どうやってグラフを作るのか知りたい方は続きを読んでもらえればと思います。Bokehの詳細な使い方は、公式ドキュメントを参考にしてください。</p>

<p>なお、ここで紹介する例は、僕が過去に出た機械学習のコンペ (<a href="https://deepanalytics.jp/compe/36?tab=compedetail">https://deepanalytics.jp/compe/36?tab=compedetail</a>) で実際に使用したコードからほぼ取ってきました（8/218位でした）。グラフを動的に更新する方法は <a href="https://bokeh.pydata.org/en/latest/docs/user_guide/notebook.html#notebook-handles">公式ドキュメント</a> に記述されていますが、そのサンプルの内容は「円を描画して色を変える」といった実用性皆無のものであること、またググっても例が多く見つからないことから、このような紹介記事を書くことにしました。参考になれば幸いです。</p>

<p>余談ではありますが、こと機械学習に関しては、tensorboardを使ったほうが簡単で良いと思います。僕は最近そうしています。 <a href="https://qiita.com/r9y9/items/d54162d37ec4f110f4b4">https://qiita.com/r9y9/items/d54162d37ec4f110f4b4</a>. 色なり位置なり大きさなりを柔軟にカスタマイズしたい、あるいはノートブックで処理を完結させたい、と言った場合には、ここで紹介する方法も良いかもしれません。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">%</span>pylab inline</code></pre></div><pre><code>Populating the interactive namespace from numpy and matplotlib</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> IPython.display <span style="color:#f92672">import</span> HTML, Image
<span style="color:#f92672">import</span> IPython
<span style="color:#f92672">from</span> os.path <span style="color:#f92672">import</span> exists

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">summary</span>():
    baseurl <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://bokeh.pydata.org/en/latest/docs/reference/models/glyphs/&#34;</span>
    <span style="color:#66d9ef">for</span> (name, figname, url) <span style="color:#f92672">in</span> [
        (<span style="color:#e6db74">&#34;Line&#34;</span>, <span style="color:#e6db74">&#34;line&#34;</span>, <span style="color:#e6db74">&#34;line.html&#34;</span>),
        (<span style="color:#e6db74">&#34;VBar&#34;</span>, <span style="color:#e6db74">&#34;vbar&#34;</span>, <span style="color:#e6db74">&#34;vbar.html&#34;</span>),
        (<span style="color:#e6db74">&#34;HBar&#34;</span>, <span style="color:#e6db74">&#34;hbar&#34;</span>, <span style="color:#e6db74">&#34;hbar.html&#34;</span>),
        (<span style="color:#e6db74">&#34;ImageRGBA&#34;</span>, <span style="color:#e6db74">&#34;gray_image&#34;</span>, <span style="color:#e6db74">&#34;image_rgba.html&#34;</span>),
        (<span style="color:#e6db74">&#34;ImageRGBA&#34;</span>, <span style="color:#e6db74">&#34;inferno_image&#34;</span>, <span style="color:#e6db74">&#34;image_rgba.html&#34;</span>),
        ]:
        gif <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;./fig/{}.gif&#34;</span><span style="color:#f92672">.</span>format(figname)
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,name, baseurl <span style="color:#f92672">+</span> url)
        <span style="color:#66d9ef">if</span> exists(gif):
            <span style="color:#66d9ef">with</span> open(gif, <span style="color:#e6db74">&#39;rb&#39;</span>) <span style="color:#66d9ef">as</span> f:
                IPython<span style="color:#f92672">.</span>display<span style="color:#f92672">.</span>display(Image(data<span style="color:#f92672">=</span>f<span style="color:#f92672">.</span>read()), format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;gif&#34;</span>)

summary()</code></pre></div>
<p>(※ブログ先頭に貼ったので省略します)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># True にしてノートブックを実行すると、上記gifの元となる画像を保存し、最後にgifを生成する</span>
save_img <span style="color:#f92672">=</span> False
<span style="color:#66d9ef">if</span> save_img:
    <span style="color:#f92672">import</span> os
    <span style="color:#f92672">from</span> os.path <span style="color:#f92672">import</span> exists
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> exists(<span style="color:#e6db74">&#34;./fig&#34;</span>):
        os<span style="color:#f92672">.</span>makedirs(<span style="color:#e6db74">&#34;./fig&#34;</span>)
    toolbar_location <span style="color:#f92672">=</span> None
<span style="color:#66d9ef">else</span>:
    toolbar_location <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;above&#34;</span>

<span style="color:#75715e"># bokehで描画したグラフはnotebookに残らないので、Trueの場合は代わりに事前に保存してあるgifを描画する</span>
<span style="color:#75715e"># もしローカルで実行するときは、Falseにしてください</span>
show_static <span style="color:#f92672">=</span> True</code></pre></div>
<h2 id="準備">準備</h2>

<p>先述の通り、ニューラルネットの学習過程の可視化を題材として、Jupyter上でのBokehの使い方を紹介していきたいと思います。今回は、PyTorch (v0.3.0) を使ってニューラルネットの学習のコードを書きました。</p>

<p><a href="https://github.com/pytorch/examples/tree/master/mnist">https://github.com/pytorch/examples/tree/master/mnist</a> をベースに、可視化しやすいように少しいじりました。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> torch
<span style="color:#f92672">import</span> torch.nn <span style="color:#f92672">as</span> nn
<span style="color:#f92672">import</span> torch.nn.functional <span style="color:#f92672">as</span> F
<span style="color:#f92672">import</span> torch.optim <span style="color:#f92672">as</span> optim
<span style="color:#f92672">from</span> torchvision <span style="color:#f92672">import</span> datasets, transforms
<span style="color:#f92672">from</span> torch.autograd <span style="color:#f92672">import</span> Variable
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np</code></pre></div>
<h3 id="data">Data</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">use_cuda <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>cuda<span style="color:#f92672">.</span>is_available()

batch_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">128</span>

kwargs <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;num_workers&#39;</span>: <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;pin_memory&#39;</span>: True} <span style="color:#66d9ef">if</span> use_cuda <span style="color:#66d9ef">else</span> {}
train_loader <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>utils<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>DataLoader(
    datasets<span style="color:#f92672">.</span>MNIST(<span style="color:#e6db74">&#39;./data&#39;</span>, train<span style="color:#f92672">=</span>True, download<span style="color:#f92672">=</span>True,
                   transform<span style="color:#f92672">=</span>transforms<span style="color:#f92672">.</span>Compose([
                       transforms<span style="color:#f92672">.</span>ToTensor()
                   ])),
    batch_size<span style="color:#f92672">=</span>batch_size, shuffle<span style="color:#f92672">=</span>True, <span style="color:#f92672">**</span>kwargs)
test_loader <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>utils<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>DataLoader(
    datasets<span style="color:#f92672">.</span>MNIST(<span style="color:#e6db74">&#39;./data&#39;</span>, train<span style="color:#f92672">=</span>False, transform<span style="color:#f92672">=</span>transforms<span style="color:#f92672">.</span>Compose([
                       transforms<span style="color:#f92672">.</span>ToTensor(),
                   ])),
    batch_size<span style="color:#f92672">=</span>batch_size, shuffle<span style="color:#f92672">=</span>False, <span style="color:#f92672">**</span>kwargs)

data_loaders <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;train&#34;</span>: train_loader, <span style="color:#e6db74">&#34;test&#34;</span>:test_loader}</code></pre></div>
<h3 id="model">Model</h3>

<p>簡単な畳み込みニューラルネットです。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Net</span>(nn<span style="color:#f92672">.</span>Module):
    <span style="color:#66d9ef">def</span> __init__(self):
        super(Net, self)<span style="color:#f92672">.</span>__init__()
        self<span style="color:#f92672">.</span>conv1 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Conv2d(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">10</span>, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
        self<span style="color:#f92672">.</span>conv2 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Conv2d(<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
        self<span style="color:#f92672">.</span>conv2_drop <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Dropout2d()
        self<span style="color:#f92672">.</span>fc1 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Linear(<span style="color:#ae81ff">320</span>, <span style="color:#ae81ff">50</span>)
        self<span style="color:#f92672">.</span>fc2 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Linear(<span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">10</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, x):
        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>relu(F<span style="color:#f92672">.</span>max_pool2d(self<span style="color:#f92672">.</span>conv1(x), <span style="color:#ae81ff">2</span>))
        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>relu(F<span style="color:#f92672">.</span>max_pool2d(self<span style="color:#f92672">.</span>conv2_drop(self<span style="color:#f92672">.</span>conv2(x)), <span style="color:#ae81ff">2</span>))
        x <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>view(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">320</span>)
        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>relu(self<span style="color:#f92672">.</span>fc1(x))
        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>dropout(x, training<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>training)
        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>fc2(x)
        <span style="color:#66d9ef">return</span> F<span style="color:#f92672">.</span>log_softmax(x, dim<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>)</code></pre></div>
<h3 id="train-loop">Train loop</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> tqdm <span style="color:#f92672">import</span> tnrange</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">epochs <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__train_loop</span>(model, data_loaders, optimizer, epoch, phase):
    model <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>train() <span style="color:#66d9ef">if</span> phase <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;train&#34;</span> <span style="color:#66d9ef">else</span> model<span style="color:#f92672">.</span>eval()
    running_loss <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    running_corrects <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    corrects <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0</span>]<span style="color:#f92672">*</span><span style="color:#ae81ff">10</span>
    counts <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0</span>]<span style="color:#f92672">*</span><span style="color:#ae81ff">10</span>
    <span style="color:#66d9ef">for</span> batch_idx, (x, y) <span style="color:#f92672">in</span> enumerate(data_loaders[phase]):
        x <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>cuda() <span style="color:#66d9ef">if</span> use_cuda <span style="color:#66d9ef">else</span> x
        y <span style="color:#f92672">=</span> y<span style="color:#f92672">.</span>cuda() <span style="color:#66d9ef">if</span> use_cuda <span style="color:#66d9ef">else</span> y
        x, y <span style="color:#f92672">=</span> Variable(x), Variable(y)
        optimizer<span style="color:#f92672">.</span>zero_grad()
        y_hat <span style="color:#f92672">=</span> model(x)

        <span style="color:#75715e"># loss</span>
        loss <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>nll_loss(y_hat, y)

        <span style="color:#75715e"># update</span>
        <span style="color:#66d9ef">if</span> phase <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;train&#34;</span>:
            loss<span style="color:#f92672">.</span>backward()
            optimizer<span style="color:#f92672">.</span>step()
        running_loss <span style="color:#f92672">+=</span> loss<span style="color:#f92672">.</span>data[<span style="color:#ae81ff">0</span>]

        <span style="color:#75715e"># predict</span>
        preds <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>max(y_hat<span style="color:#f92672">.</span>data, <span style="color:#ae81ff">1</span>)[<span style="color:#ae81ff">1</span>]
        match <span style="color:#f92672">=</span> (preds <span style="color:#f92672">==</span> y<span style="color:#f92672">.</span>data)<span style="color:#f92672">.</span>cpu()
        running_corrects <span style="color:#f92672">+=</span> match<span style="color:#f92672">.</span>sum()

        <span style="color:#75715e"># カテゴリごとの正解率を出すのにほしい</span>
        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(match)):
            <span style="color:#66d9ef">if</span> match<span style="color:#f92672">.</span>view(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)[i] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
                corrects[y<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>view(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)[i]] <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(match)):
            counts[y<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>view(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)[i]] <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>

    <span style="color:#75715e"># epoch-wise metrics</span>
    l <span style="color:#f92672">=</span> running_loss <span style="color:#f92672">/</span> len(data_loaders[phase])
    acc <span style="color:#f92672">=</span> running_corrects <span style="color:#f92672">/</span> len(data_loaders[phase]<span style="color:#f92672">.</span>dataset)
    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;loss&#34;</span>: l, <span style="color:#e6db74">&#34;acc&#34;</span>: acc, <span style="color:#e6db74">&#34;corrects&#34;</span>: corrects, <span style="color:#e6db74">&#34;counts&#34;</span>: counts}

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train_loop</span>(model, data_loaders, optimizer, epochs<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>, callback<span style="color:#f92672">=</span>None):
    history <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;train&#34;</span>: {}, <span style="color:#e6db74">&#34;test&#34;</span>: {}}
    <span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> tnrange(epochs):
        <span style="color:#66d9ef">for</span> phase <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#34;train&#34;</span>, <span style="color:#e6db74">&#34;test&#34;</span>]:
            d <span style="color:#f92672">=</span> __train_loop(model, data_loaders, optimizer, epoch, phase)
            <span style="color:#66d9ef">for</span> k,v <span style="color:#f92672">in</span> d<span style="color:#f92672">.</span>items():
                <span style="color:#66d9ef">try</span>:
                    history[phase][k]<span style="color:#f92672">.</span>append(v)
                <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">KeyError</span>:
                    history[phase][k] <span style="color:#f92672">=</span> [v]

            <span style="color:#75715e"># ここでグラフの更新を呼ぶ想定です</span>
            <span style="color:#66d9ef">if</span> callback <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> None:
                callback<span style="color:#f92672">.</span>on_epoch_end(epoch, phase, history)
    <span style="color:#66d9ef">return</span> history</code></pre></div>
<h2 id="本編">本編</h2>

<h3 id="0-matplotlib">0. Matplotlib</h3>

<p>まずはじめに、動的ではない（静的な）グラフの例を示します。手書き数字認識のような識別タスクにおいて、最も一般的であると思われる評価尺度として、ロスと正解率を可視化します。<code>train_loop</code>関数は、返り値にロスと正解率のhistoryを返すようにしたので、それを使ってグラフを作ります。</p>

<p>図の作成にはいろんなツールがあると思うのですが、matplotlibが定番で（僕は）大きな不満もないので、よく使っています。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">model <span style="color:#f92672">=</span> Net()<span style="color:#f92672">.</span>cuda() <span style="color:#66d9ef">if</span> use_cuda <span style="color:#66d9ef">else</span> Net()
optimizer <span style="color:#f92672">=</span> optim<span style="color:#f92672">.</span>Adadelta(model<span style="color:#f92672">.</span>parameters())
history <span style="color:#f92672">=</span> train_loop(model, data_loaders, optimizer, epochs)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Test loss: {:.3f}&#34;</span><span style="color:#f92672">.</span>format(history[<span style="color:#e6db74">&#34;train&#34;</span>][<span style="color:#e6db74">&#34;loss&#34;</span>][<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]))
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Test acc: {:.3f}&#34;</span><span style="color:#f92672">.</span>format(history[<span style="color:#e6db74">&#34;test&#34;</span>][<span style="color:#e6db74">&#34;acc&#34;</span>][<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]))</code></pre></div><pre><code>Test loss: 0.111
Test acc: 0.989</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">matplotlib<span style="color:#f92672">.</span>pyplot<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">16</span>,<span style="color:#ae81ff">6</span>))
subplot(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">1</span>)
plot(history[<span style="color:#e6db74">&#34;train&#34;</span>][<span style="color:#e6db74">&#34;loss&#34;</span>], linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;red&#34;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;train loss&#34;</span>)
plot(history[<span style="color:#e6db74">&#34;test&#34;</span>][<span style="color:#e6db74">&#34;loss&#34;</span>], linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;blue&#34;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test lsos&#34;</span>)
xlabel(<span style="color:#e6db74">&#34;epoch&#34;</span>, fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>)
legend(prop<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;size&#34;</span>: <span style="color:#ae81ff">16</span>})
subplot(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">2</span>)
plot(history[<span style="color:#e6db74">&#34;train&#34;</span>][<span style="color:#e6db74">&#34;acc&#34;</span>], linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;red&#34;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;train acc&#34;</span>)
plot(history[<span style="color:#e6db74">&#34;test&#34;</span>][<span style="color:#e6db74">&#34;acc&#34;</span>], linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;blue&#34;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test acc&#34;</span>)
xlabel(<span style="color:#e6db74">&#34;epoch&#34;</span>, fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>)</code></pre></div><pre><code>&lt;matplotlib.text.Text at 0x7f16fa9ca438&gt;</code></pre>
<p><img src="/images/jupyter_with_bokeh_files/jupyter_with_bokeh_16_1.png" alt="png" /></p>

<h3 id="1-line">1. Line</h3>

<p>次に、上記の線グラフを、Bokehを使って作ってみます。これには、 <a href="https://bokeh.pydata.org/en/latest/docs/reference/models/glyphs/line.html">https://bokeh.pydata.org/en/latest/docs/reference/models/glyphs/line.html</a> が使えます。</p>

<p>bokehで作ったグラフをnotebookにinline plotするためには、<a href="https://bokeh.pydata.org/en/latest/docs/reference/io.html#bokeh.io.output_notebook">bokeh.io.output_notebook</a> を呼び出しておく必要があります。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> bokeh
<span style="color:#f92672">import</span> bokeh.io
<span style="color:#f92672">from</span> bokeh.io <span style="color:#f92672">import</span> push_notebook, show, output_notebook
<span style="color:#f92672">from</span> bokeh.plotting <span style="color:#f92672">import</span> figure
<span style="color:#66d9ef">try</span>:
    <span style="color:#75715e"># 少し古いbokehだとこっち</span>
    <span style="color:#f92672">from</span> bokeh.io <span style="color:#f92672">import</span> gridplot
<span style="color:#66d9ef">except</span> <span style="color:#a6e22e">ImportError</span>:
    <span style="color:#f92672">from</span> bokeh.layouts <span style="color:#f92672">import</span> gridplot

output_notebook()</code></pre></div>
<p>次に定義する <code>LinePlotsCallback</code> は、グラフの情報をプロパティに保持し、<code>on_epoch_end</code> で学習結果のhisotoryを受け取って、ロスと正解率のグラフを更新します。 historyには、今回の場合は、</p>

<ul>
<li>ロス (float)</li>
<li>正解率 (float)</li>
<li>カテゴリ毎の総サンプル数 (list)</li>
<li>カテゴリ毎の正解サンプル数 (list)</li>
</ul>

<p>の4つを含めるように実装しました (<code>train_loop</code> 関数を参照)。<code>LinePlotsCallback</code> では、このうちロスと正解率を随時受け取って、グラフを更新します。<code>Line</code> オブジェクトの更新には、<code>data_source.data[&quot;x&quot;]</code>, <code>data_source.data[&quot;y&quot;]</code> に随時値を追加していくことで行います。</p>

<p>以降示すグラフでも同じなのですが、グラフを生成する基本的な手順をまとめると、</p>

<ul>
<li><a href="https://bokeh.pydata.org/en/latest/docs/reference/plotting.html">bokeh.plotting.figure</a> により、figureオブジェクトを生成する</li>
<li>生成したfigureオブジェクトに対して、線グラフ、棒グラフといったパーツ (レンダラ、bokehでは<a href="https://bokeh.pydata.org/en/latest/docs/reference/models/glyphs.html">glyphs</a>と呼ぶ) を生成する</li>
<li>(今回は格子状に図を配置したかったので）複数のfigureオブジェクトをgrid上にレイアウトする</li>
</ul>

<p>となっています。格子状に配置しない場合は最後のステップは不要ですが、便利なので使います。</p>

<p>グラフの更新は、レンダラに値をセットしたあとに、<a href="https://bokeh.pydata.org/en/latest/docs/reference/io.html#bokeh.io.push_notebook">bokeh.io.push_notebook</a> を呼び出すことで行います。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LinePlotsCallback</span>(object):
    <span style="color:#66d9ef">def</span> __init__(self, epochs<span style="color:#f92672">=</span>epochs, batch_size<span style="color:#f92672">=</span>batch_size):
        <span style="color:#75715e"># Epoch毎</span>
        p1 <span style="color:#f92672">=</span> figure(title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Loss&#34;</span>, plot_height<span style="color:#f92672">=</span><span style="color:#ae81ff">300</span>, plot_width<span style="color:#f92672">=</span><span style="color:#ae81ff">350</span>,
                        y_range<span style="color:#f92672">=</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.5</span>), x_range<span style="color:#f92672">=</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, epochs<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>))
        p2 <span style="color:#f92672">=</span> figure(title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Acc&#34;</span>, plot_height<span style="color:#f92672">=</span><span style="color:#ae81ff">300</span>, plot_width<span style="color:#f92672">=</span><span style="color:#ae81ff">350</span>,
                        y_range<span style="color:#f92672">=</span>(<span style="color:#ae81ff">0.8</span>, <span style="color:#ae81ff">1.0</span>), x_range<span style="color:#f92672">=</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, epochs<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>))

        self<span style="color:#f92672">.</span>renderers <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;train&#34;</span>:{}, <span style="color:#e6db74">&#34;test&#34;</span>:{}}

        <span style="color:#75715e"># 赤: train, 青: テスト</span>
        <span style="color:#66d9ef">for</span> phase, c <span style="color:#f92672">in</span> [(<span style="color:#e6db74">&#34;train&#34;</span>, <span style="color:#e6db74">&#34;red&#34;</span>), (<span style="color:#e6db74">&#34;test&#34;</span>, <span style="color:#e6db74">&#34;blue&#34;</span>)]:
            <span style="color:#66d9ef">for</span> (p, key) <span style="color:#f92672">in</span> [(p1, <span style="color:#e6db74">&#34;loss&#34;</span>), (p2, <span style="color:#e6db74">&#34;acc&#34;</span>)]:
                self<span style="color:#f92672">.</span>renderers[phase][key] <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>line([], [], color<span style="color:#f92672">=</span>c, line_width<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>)

        self<span style="color:#f92672">.</span>graph <span style="color:#f92672">=</span> gridplot([p1, p2], ncols<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, toolbar_location<span style="color:#f92672">=</span>toolbar_location)


    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_epoch_end</span>(self, epoch, phase, history):
        <span style="color:#66d9ef">for</span> key <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#34;loss&#34;</span>, <span style="color:#e6db74">&#34;acc&#34;</span>]:
            self<span style="color:#f92672">.</span>renderers[phase][key]<span style="color:#f92672">.</span>data_source<span style="color:#f92672">.</span>data[<span style="color:#e6db74">&#34;x&#34;</span>]<span style="color:#f92672">.</span>append(epoch)
            self<span style="color:#f92672">.</span>renderers[phase][key]<span style="color:#f92672">.</span>data_source<span style="color:#f92672">.</span>data[<span style="color:#e6db74">&#34;y&#34;</span>]<span style="color:#f92672">.</span>append(history[phase][key][<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
        push_notebook()
        <span style="color:#66d9ef">if</span> save_img:
            bokeh<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>export_png(self<span style="color:#f92672">.</span>graph, <span style="color:#e6db74">&#34;fig/{:02d}_line.png&#34;</span><span style="color:#f92672">.</span>format(epoch))</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">callback <span style="color:#f92672">=</span> LinePlotsCallback()
<span style="color:#66d9ef">if</span> show_static:
    <span style="color:#66d9ef">if</span> exists(<span style="color:#e6db74">&#34;fig/line.gif&#34;</span>):
        <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;fig/line.gif&#34;</span>, <span style="color:#e6db74">&#39;rb&#39;</span>) <span style="color:#66d9ef">as</span> f:
            IPython<span style="color:#f92672">.</span>display<span style="color:#f92672">.</span>display(Image(data<span style="color:#f92672">=</span>f<span style="color:#f92672">.</span>read()), format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;gif&#34;</span>)
<span style="color:#66d9ef">else</span>:
    bokeh<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>show(callback<span style="color:#f92672">.</span>graph, notebook_handle<span style="color:#f92672">=</span>True)</code></pre></div>
<p><img src="/images/jupyter_with_bokeh_files/jupyter_with_bokeh_21_0.png" alt="png" /></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">model <span style="color:#f92672">=</span> Net()<span style="color:#f92672">.</span>cuda() <span style="color:#66d9ef">if</span> use_cuda <span style="color:#66d9ef">else</span> Net()
optimizer <span style="color:#f92672">=</span> optim<span style="color:#f92672">.</span>Adadelta(model<span style="color:#f92672">.</span>parameters())
history <span style="color:#f92672">=</span> train_loop(model, data_loaders, optimizer, epochs, callback<span style="color:#f92672">=</span>callback)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Test loss: {:.3f}&#34;</span><span style="color:#f92672">.</span>format(history[<span style="color:#e6db74">&#34;train&#34;</span>][<span style="color:#e6db74">&#34;loss&#34;</span>][<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]))
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Test acc: {:.3f}&#34;</span><span style="color:#f92672">.</span>format(history[<span style="color:#e6db74">&#34;test&#34;</span>][<span style="color:#e6db74">&#34;acc&#34;</span>][<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]))</code></pre></div><pre><code>Test loss: 0.113
Test acc: 0.990</code></pre>
<h3 id="2-vbar">2. VBar</h3>

<p>データセット全体の正解率だけでなく、カテゴリ毎の正解率などの尺度を知りたい時がよくあります。次は、数字の各カテゴリごとにどのくらい正解しているのか、といった尺度を可視化するために、縦棒グラフを作ってみます。これには、 <a href="https://bokeh.pydata.org/en/latest/docs/reference/models/glyphs/vbar.html">https://bokeh.pydata.org/en/latest/docs/reference/models/glyphs/vbar.html</a> が使えます。on_epoch_endで渡されるhistoryのうち、</p>

<ul>
<li>カテゴリ毎の総サンプル数 (list)</li>
<li>カテゴリ毎の正解サンプル数 (list)</li>
</ul>

<p>の二つを使って動的にグラフを更新します。</p>

<p><code>Line</code> オブジェクトの更新は、<code>data_source.data[&quot;x&quot;]</code>, <code>data_source.data[&quot;y&quot;]</code> に値を追加していくことで行いましたが、<code>VBar</code>オブジェクトの場合は、<code>data_source.data[&quot;top&quot;]</code> に値をセットします。下向きの棒グラフが作りたい場合は、<code>data_source.data[&quot;bottom&quot;]</code> に値をセットすればOKです。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">VBarPlotsCallback</span>(object):
    <span style="color:#66d9ef">def</span> __init__(self, epochs<span style="color:#f92672">=</span>epochs, batch_size<span style="color:#f92672">=</span>batch_size):
        <span style="color:#75715e"># Epoch毎</span>
        p1 <span style="color:#f92672">=</span> figure(title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Category-wise correctness (train)&#34;</span>,
                    plot_height<span style="color:#f92672">=</span><span style="color:#ae81ff">300</span>, plot_width<span style="color:#f92672">=</span><span style="color:#ae81ff">350</span>, y_range<span style="color:#f92672">=</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">7000</span>))
        p2 <span style="color:#f92672">=</span> figure(title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Category-wise correctness (test)&#34;</span>,
                    plot_height<span style="color:#f92672">=</span><span style="color:#ae81ff">300</span>, plot_width<span style="color:#f92672">=</span><span style="color:#ae81ff">350</span>, y_range<span style="color:#f92672">=</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1500</span>))

        self<span style="color:#f92672">.</span>renderers <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;train&#34;</span>:{}, <span style="color:#e6db74">&#34;test&#34;</span>:{}}

        bar_opts <span style="color:#f92672">=</span> dict(width<span style="color:#f92672">=</span><span style="color:#ae81ff">0.8</span>, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>)
        <span style="color:#66d9ef">for</span> phase, p <span style="color:#f92672">in</span> [(<span style="color:#e6db74">&#34;train&#34;</span>, p1), (<span style="color:#e6db74">&#34;test&#34;</span>, p2)]:
            <span style="color:#66d9ef">for</span> (key, c) <span style="color:#f92672">in</span> [(<span style="color:#e6db74">&#34;corrects&#34;</span>, <span style="color:#e6db74">&#34;blue&#34;</span>), (<span style="color:#e6db74">&#34;counts&#34;</span>, <span style="color:#e6db74">&#34;red&#34;</span>)]:
                self<span style="color:#f92672">.</span>renderers[phase][key] <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>vbar(
                    x<span style="color:#f92672">=</span>np<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">10</span>), top<span style="color:#f92672">=</span>[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">*</span><span style="color:#ae81ff">10</span>, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test&#34;</span>, color<span style="color:#f92672">=</span>c, <span style="color:#f92672">**</span>bar_opts)

        self<span style="color:#f92672">.</span>graph <span style="color:#f92672">=</span> gridplot([p1, p2], ncols<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, toolbar_location<span style="color:#f92672">=</span>toolbar_location)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_epoch_end</span>(self, epoch, phase, history):
        <span style="color:#66d9ef">for</span> key <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#34;counts&#34;</span>, <span style="color:#e6db74">&#34;corrects&#34;</span>]:
            self<span style="color:#f92672">.</span>renderers[phase][key]<span style="color:#f92672">.</span>data_source<span style="color:#f92672">.</span>data[<span style="color:#e6db74">&#34;top&#34;</span>] <span style="color:#f92672">=</span> history[phase][key][<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
            push_notebook()
        <span style="color:#66d9ef">if</span> save_img:
            bokeh<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>export_png(self<span style="color:#f92672">.</span>graph, <span style="color:#e6db74">&#34;fig/{:02d}_vbar.png&#34;</span><span style="color:#f92672">.</span>format(epoch))</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">callback <span style="color:#f92672">=</span> VBarPlotsCallback()
<span style="color:#66d9ef">if</span> show_static:
    <span style="color:#66d9ef">if</span> exists(<span style="color:#e6db74">&#34;fig/vbar.gif&#34;</span>):
        <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;fig/vbar.gif&#34;</span>, <span style="color:#e6db74">&#39;rb&#39;</span>) <span style="color:#66d9ef">as</span> f:
            IPython<span style="color:#f92672">.</span>display<span style="color:#f92672">.</span>display(Image(data<span style="color:#f92672">=</span>f<span style="color:#f92672">.</span>read()), format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;gif&#34;</span>)
<span style="color:#66d9ef">else</span>:
    bokeh<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>show(callback<span style="color:#f92672">.</span>graph, notebook_handle<span style="color:#f92672">=</span>True)</code></pre></div>
<p><img src="/images/jupyter_with_bokeh_files/jupyter_with_bokeh_25_0.png" alt="png" /></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">model <span style="color:#f92672">=</span> Net()<span style="color:#f92672">.</span>cuda() <span style="color:#66d9ef">if</span> use_cuda <span style="color:#66d9ef">else</span> Net()
optimizer <span style="color:#f92672">=</span> optim<span style="color:#f92672">.</span>Adadelta(model<span style="color:#f92672">.</span>parameters())
history <span style="color:#f92672">=</span> train_loop(model, data_loaders, optimizer, epochs, callback<span style="color:#f92672">=</span>callback)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Test loss: {:.3f}&#34;</span><span style="color:#f92672">.</span>format(history[<span style="color:#e6db74">&#34;train&#34;</span>][<span style="color:#e6db74">&#34;loss&#34;</span>][<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]))
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Test acc: {:.3f}&#34;</span><span style="color:#f92672">.</span>format(history[<span style="color:#e6db74">&#34;test&#34;</span>][<span style="color:#e6db74">&#34;acc&#34;</span>][<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]))</code></pre></div><pre><code>Test loss: 0.115
Test acc: 0.989</code></pre>
<h3 id="3-hbar">3. HBar</h3>

<p>HBarと非常に似たグラフとして、横向きの棒グラフである <a href="https://bokeh.pydata.org/en/latest/docs/reference/models/glyphs/hbar.html">https://bokeh.pydata.org/en/latest/docs/reference/models/glyphs/hbar.html</a> があります。VBarの場合と同様に、カテゴリ毎の正解サンプル数を可視化してみます。本質的に可視化する情報は変わりませんが、あくまでデモということで。</p>

<p><code>HBar</code>オブジェクトの更新は、<code>data_source.data[&quot;right&quot;]</code> or <code>data_source.data[&quot;left&quot;]</code> に値をセットすればOKです。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HBarPlotsCallback</span>(object):
    <span style="color:#66d9ef">def</span> __init__(self, epochs<span style="color:#f92672">=</span>epochs, batch_size<span style="color:#f92672">=</span>batch_size):
        <span style="color:#75715e"># Epoch毎</span>
        p1 <span style="color:#f92672">=</span> figure(title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Category-wise correctness (train)&#34;</span>,
                    plot_height<span style="color:#f92672">=</span><span style="color:#ae81ff">300</span>, plot_width<span style="color:#f92672">=</span><span style="color:#ae81ff">350</span>, x_range<span style="color:#f92672">=</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">7000</span>))
        p2 <span style="color:#f92672">=</span> figure(title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Category-wise correctness (test)&#34;</span>,
                    plot_height<span style="color:#f92672">=</span><span style="color:#ae81ff">300</span>, plot_width<span style="color:#f92672">=</span><span style="color:#ae81ff">350</span>, x_range<span style="color:#f92672">=</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1500</span>))

        self<span style="color:#f92672">.</span>renderers <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;train&#34;</span>:{}, <span style="color:#e6db74">&#34;test&#34;</span>:{}}

        bar_opts <span style="color:#f92672">=</span> dict(height<span style="color:#f92672">=</span><span style="color:#ae81ff">0.8</span>, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>)
        <span style="color:#66d9ef">for</span> phase, p <span style="color:#f92672">in</span> [(<span style="color:#e6db74">&#34;train&#34;</span>, p1), (<span style="color:#e6db74">&#34;test&#34;</span>, p2)]:
            <span style="color:#66d9ef">for</span> (key, c) <span style="color:#f92672">in</span> [(<span style="color:#e6db74">&#34;corrects&#34;</span>, <span style="color:#e6db74">&#34;blue&#34;</span>), (<span style="color:#e6db74">&#34;counts&#34;</span>, <span style="color:#e6db74">&#34;green&#34;</span>)]:
                self<span style="color:#f92672">.</span>renderers[phase][key] <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>hbar(
                    y<span style="color:#f92672">=</span>np<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">10</span>), right<span style="color:#f92672">=</span>[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">*</span><span style="color:#ae81ff">10</span>, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test&#34;</span>, color<span style="color:#f92672">=</span>c, <span style="color:#f92672">**</span>bar_opts)

        self<span style="color:#f92672">.</span>graph <span style="color:#f92672">=</span> gridplot([p1, p2], ncols<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, toolbar_location<span style="color:#f92672">=</span>toolbar_location)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_epoch_end</span>(self, epoch, phase, history):
        <span style="color:#66d9ef">for</span> key <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#34;counts&#34;</span>, <span style="color:#e6db74">&#34;corrects&#34;</span>]:
            self<span style="color:#f92672">.</span>renderers[phase][key]<span style="color:#f92672">.</span>data_source<span style="color:#f92672">.</span>data[<span style="color:#e6db74">&#34;right&#34;</span>] <span style="color:#f92672">=</span> history[phase][key][<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
            push_notebook()
        <span style="color:#66d9ef">if</span> save_img:
            bokeh<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>export_png(self<span style="color:#f92672">.</span>graph, <span style="color:#e6db74">&#34;fig/{:02d}_hbar.png&#34;</span><span style="color:#f92672">.</span>format(epoch))</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">callback <span style="color:#f92672">=</span> HBarPlotsCallback()
<span style="color:#66d9ef">if</span> show_static:
    <span style="color:#66d9ef">if</span> exists(<span style="color:#e6db74">&#34;fig/hbar.gif&#34;</span>):
        <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;fig/hbar.gif&#34;</span>, <span style="color:#e6db74">&#39;rb&#39;</span>) <span style="color:#66d9ef">as</span> f:
            IPython<span style="color:#f92672">.</span>display<span style="color:#f92672">.</span>display(Image(data<span style="color:#f92672">=</span>f<span style="color:#f92672">.</span>read()), format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;gif&#34;</span>)
<span style="color:#66d9ef">else</span>:
    bokeh<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>show(callback<span style="color:#f92672">.</span>graph, notebook_handle<span style="color:#f92672">=</span>True)</code></pre></div>
<p><img src="/images/jupyter_with_bokeh_files/jupyter_with_bokeh_29_0.png" alt="png" /></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">model <span style="color:#f92672">=</span> Net()<span style="color:#f92672">.</span>cuda() <span style="color:#66d9ef">if</span> use_cuda <span style="color:#66d9ef">else</span> Net()
optimizer <span style="color:#f92672">=</span> optim<span style="color:#f92672">.</span>Adadelta(model<span style="color:#f92672">.</span>parameters())
history <span style="color:#f92672">=</span> train_loop(model, data_loaders, optimizer, epochs, callback<span style="color:#f92672">=</span>callback)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Test loss: {:.3f}&#34;</span><span style="color:#f92672">.</span>format(history[<span style="color:#e6db74">&#34;train&#34;</span>][<span style="color:#e6db74">&#34;loss&#34;</span>][<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]))
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Test acc: {:.3f}&#34;</span><span style="color:#f92672">.</span>format(history[<span style="color:#e6db74">&#34;test&#34;</span>][<span style="color:#e6db74">&#34;acc&#34;</span>][<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]))</code></pre></div><pre><code>Test loss: 0.116
Test acc: 0.989</code></pre>
<h3 id="5-image">5. Image</h3>

<p>最後に、<a href="https://bokeh.pydata.org/en/latest/docs/reference/models/glyphs/image_rgba.html">https://bokeh.pydata.org/en/latest/docs/reference/models/glyphs/image_rgba.html</a> を使って、画像を可視化する例を紹介します。例えば生成モデルを学習するときなど、学習の過程で、その生成サンプルを可視化したい場合がよくあるので、そういった場合に使えます。</p>

<p>最初に実装したモデルは手書き数字認識のための識別モデルだったため、趣向を変えて、生成モデルである Variational Auto-encoder (VAE) を使います。識別モデルの学習と生成モデルの学習は少し毛色が違うので、（ほとんど同じですが、簡単のため）併せて学習用のコードを書き換えました。</p>

<h4 id="vae">VAE</h4>

<p><a href="https://github.com/pytorch/examples/tree/master/vae">https://github.com/pytorch/examples/tree/master/vae</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">VAE</span>(nn<span style="color:#f92672">.</span>Module):
    <span style="color:#66d9ef">def</span> __init__(self):
        super(VAE, self)<span style="color:#f92672">.</span>__init__()

        self<span style="color:#f92672">.</span>fc1 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Linear(<span style="color:#ae81ff">784</span>, <span style="color:#ae81ff">400</span>)
        self<span style="color:#f92672">.</span>fc21 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Linear(<span style="color:#ae81ff">400</span>, <span style="color:#ae81ff">20</span>)
        self<span style="color:#f92672">.</span>fc22 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Linear(<span style="color:#ae81ff">400</span>, <span style="color:#ae81ff">20</span>)
        self<span style="color:#f92672">.</span>fc3 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Linear(<span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">400</span>)
        self<span style="color:#f92672">.</span>fc4 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Linear(<span style="color:#ae81ff">400</span>, <span style="color:#ae81ff">784</span>)

        self<span style="color:#f92672">.</span>relu <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>ReLU()
        self<span style="color:#f92672">.</span>sigmoid <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Sigmoid()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">encode</span>(self, x):
        h1 <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>relu(self<span style="color:#f92672">.</span>fc1(x))
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>fc21(h1), self<span style="color:#f92672">.</span>fc22(h1)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">reparameterize</span>(self, mu, logvar):
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>training:
            std <span style="color:#f92672">=</span> logvar<span style="color:#f92672">.</span>mul(<span style="color:#ae81ff">0.5</span>)<span style="color:#f92672">.</span>exp_()
            eps <span style="color:#f92672">=</span> Variable(std<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>new(std<span style="color:#f92672">.</span>size())<span style="color:#f92672">.</span>normal_())
            <span style="color:#66d9ef">return</span> eps<span style="color:#f92672">.</span>mul(std)<span style="color:#f92672">.</span>add_(mu)
        <span style="color:#66d9ef">else</span>:
            <span style="color:#66d9ef">return</span> mu

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decode</span>(self, z):
        h3 <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>relu(self<span style="color:#f92672">.</span>fc3(z))
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>sigmoid(self<span style="color:#f92672">.</span>fc4(h3))

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, x):
        mu, logvar <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>encode(x<span style="color:#f92672">.</span>view(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">784</span>))
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>reparameterize(mu, logvar)
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>decode(z), mu, logvar

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">loss_function</span>(recon_x, x, mu, logvar):
    BCE <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>binary_cross_entropy(recon_x, x<span style="color:#f92672">.</span>view(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">784</span>))

    <span style="color:#75715e"># see Appendix B from VAE paper:</span>
    <span style="color:#75715e"># Kingma and Welling. Auto-Encoding Variational Bayes. ICLR, 2014</span>
    <span style="color:#75715e"># https://arxiv.org/abs/1312.6114</span>
    <span style="color:#75715e"># 0.5 * sum(1 + log(sigma^2) - mu^2 - sigma^2)</span>
    KLD <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">0.5</span> <span style="color:#f92672">*</span> torch<span style="color:#f92672">.</span>sum(<span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> logvar <span style="color:#f92672">-</span> mu<span style="color:#f92672">.</span>pow(<span style="color:#ae81ff">2</span>) <span style="color:#f92672">-</span> logvar<span style="color:#f92672">.</span>exp())
    <span style="color:#75715e"># Normalise by same number of elements as in reconstruction</span>
    KLD <span style="color:#f92672">/=</span> batch_size <span style="color:#f92672">*</span> <span style="color:#ae81ff">784</span>

    <span style="color:#66d9ef">return</span> BCE <span style="color:#f92672">+</span> KLD</code></pre></div>
<h4 id="training-loop">Training loop</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__train_loop_vae</span>(model, data_loaders, optimizer, epoch, phase):
    model <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>train() <span style="color:#66d9ef">if</span> phase <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;train&#34;</span> <span style="color:#66d9ef">else</span> model<span style="color:#f92672">.</span>eval()
    running_loss <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    recon_batch_first, target <span style="color:#f92672">=</span> None, None
    <span style="color:#66d9ef">for</span> batch_idx, (x, _) <span style="color:#f92672">in</span> enumerate(data_loaders[phase]):
        x <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>cuda() <span style="color:#66d9ef">if</span> use_cuda <span style="color:#66d9ef">else</span> x
        x <span style="color:#f92672">=</span> Variable(x)
        optimizer<span style="color:#f92672">.</span>zero_grad()
        y_hat <span style="color:#f92672">=</span> model(x)

        <span style="color:#75715e"># loss</span>
        recon_batch, mu, logvar <span style="color:#f92672">=</span> model(x)
        loss <span style="color:#f92672">=</span> loss_function(recon_batch, x, mu, logvar)

        <span style="color:#75715e"># update</span>
        <span style="color:#66d9ef">if</span> phase <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;train&#34;</span>:
            loss<span style="color:#f92672">.</span>backward()
            optimizer<span style="color:#f92672">.</span>step()
        running_loss <span style="color:#f92672">+=</span> loss<span style="color:#f92672">.</span>data[<span style="color:#ae81ff">0</span>]

        <span style="color:#66d9ef">if</span> target <span style="color:#f92672">is</span> None:
            target <span style="color:#f92672">=</span> x
            recon_batch_first <span style="color:#f92672">=</span> recon_batch

    <span style="color:#75715e"># epoch-wise metrics</span>
    l <span style="color:#f92672">=</span> running_loss <span style="color:#f92672">/</span> len(data_loaders[phase])
    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;loss&#34;</span>: l, <span style="color:#e6db74">&#34;recon&#34;</span>: recon_batch_first<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>cpu(), <span style="color:#e6db74">&#34;target&#34;</span>: target<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>cpu()}

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train_loop_vae</span>(model, data_loaders, optimizer, epochs<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>, callback<span style="color:#f92672">=</span>None):
    history <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;train&#34;</span>: {}, <span style="color:#e6db74">&#34;test&#34;</span>: {}}
    <span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> tnrange(epochs):
        <span style="color:#66d9ef">for</span> phase <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#34;train&#34;</span>, <span style="color:#e6db74">&#34;test&#34;</span>]:
            d <span style="color:#f92672">=</span> __train_loop_vae(model, data_loaders, optimizer, epoch, phase)
            <span style="color:#66d9ef">for</span> k,v <span style="color:#f92672">in</span> d<span style="color:#f92672">.</span>items():
                <span style="color:#66d9ef">try</span>:
                    history[phase][k]<span style="color:#f92672">.</span>append(v)
                <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">KeyError</span>:
                    history[phase][k] <span style="color:#f92672">=</span> [v]

            <span style="color:#66d9ef">if</span> callback <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> None:
                callback<span style="color:#f92672">.</span>on_epoch_end(epoch, phase, history)
    <span style="color:#66d9ef">return</span> history</code></pre></div>
<p>さて、準備は終わりです。</p>

<p>次に示す <code>ImagePlotsCallback</code> は、<code>on_epoch_end</code> で学習結果のhisotoryを受け取って、VAEを通して復元した画像と、復元したい対象の画像を動的に更新します。ImageRGBA の場合は、<code>data_source.data[&quot;image&quot;]</code> に配列をセットすることで、更新することができます。</p>

<p>注意事項として、モノクロ画像を描画する際には、適当なカラーマップをかけて、(w, h) -&gt; (w, h, 4) の配列にしておく必要があります。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> torchvision.utils <span style="color:#f92672">import</span> make_grid
<span style="color:#f92672">from</span> matplotlib.pyplot <span style="color:#f92672">import</span> cm

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_to_img</span>(batch, cmap<span style="color:#f92672">=</span>cm<span style="color:#f92672">.</span>gray):
    <span style="color:#75715e"># 128は多かったので半分にします</span>
    _batch_size <span style="color:#f92672">=</span> batch_size <span style="color:#f92672">//</span> <span style="color:#ae81ff">2</span>
    batch <span style="color:#f92672">=</span> batch[:_batch_size]

    batch <span style="color:#f92672">=</span> batch<span style="color:#f92672">.</span>view(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">28</span>,<span style="color:#ae81ff">28</span>)
    grid <span style="color:#f92672">=</span> make_grid(batch, nrow<span style="color:#f92672">=</span>int(np<span style="color:#f92672">.</span>sqrt(_batch_size)))[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>numpy()
    <span style="color:#75715e"># Force squared</span>
    l <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>min(grid<span style="color:#f92672">.</span>shape)
    grid <span style="color:#f92672">=</span> grid[:l, :l]
    img <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>uint8(cmap(grid) <span style="color:#f92672">*</span> <span style="color:#ae81ff">255</span>)
    <span style="color:#66d9ef">return</span> img

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ImagePlotsCallback</span>(object):
    <span style="color:#66d9ef">def</span> __init__(self, epochs<span style="color:#f92672">=</span>epochs, batch_size<span style="color:#f92672">=</span>batch_size, cmap<span style="color:#f92672">=</span>cm<span style="color:#f92672">.</span>gray):
        x_range, y_range <span style="color:#f92672">=</span> (<span style="color:#f92672">-</span><span style="color:#ae81ff">0.5</span>, <span style="color:#ae81ff">10.5</span>), (<span style="color:#f92672">-</span><span style="color:#ae81ff">0.5</span>, <span style="color:#ae81ff">10.5</span>)
        p1 <span style="color:#f92672">=</span> figure(title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Reconstructed (train)&#34;</span>,
                    plot_height<span style="color:#f92672">=</span><span style="color:#ae81ff">350</span>, plot_width<span style="color:#f92672">=</span><span style="color:#ae81ff">350</span>, x_range<span style="color:#f92672">=</span>x_range, y_range<span style="color:#f92672">=</span>y_range)
        p2 <span style="color:#f92672">=</span> figure(title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Target (train)&#34;</span>,
                    plot_height<span style="color:#f92672">=</span><span style="color:#ae81ff">350</span>, plot_width<span style="color:#f92672">=</span><span style="color:#ae81ff">350</span>, x_range<span style="color:#f92672">=</span>x_range, y_range<span style="color:#f92672">=</span>y_range)
        p3 <span style="color:#f92672">=</span> figure(title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Reconstructed (test)&#34;</span>,
                    plot_height<span style="color:#f92672">=</span><span style="color:#ae81ff">350</span>, plot_width<span style="color:#f92672">=</span><span style="color:#ae81ff">350</span>, x_range<span style="color:#f92672">=</span>x_range, y_range<span style="color:#f92672">=</span>y_range)
        p4 <span style="color:#f92672">=</span> figure(title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Target (test)&#34;</span>,
                    plot_height<span style="color:#f92672">=</span><span style="color:#ae81ff">350</span>, plot_width<span style="color:#f92672">=</span><span style="color:#ae81ff">350</span>, x_range<span style="color:#f92672">=</span>x_range, y_range<span style="color:#f92672">=</span>y_range)
        self<span style="color:#f92672">.</span>cmap <span style="color:#f92672">=</span> cmap

        self<span style="color:#f92672">.</span>renderers <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;train&#34;</span>:{}, <span style="color:#e6db74">&#34;test&#34;</span>:{}}
        empty <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>zeros(batch_size,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">28</span>,<span style="color:#ae81ff">28</span>)
        empty <span style="color:#f92672">=</span> _to_img(empty, self<span style="color:#f92672">.</span>cmap)
        <span style="color:#75715e"># to adjast aspect ratio</span>
        r <span style="color:#f92672">=</span> empty<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">/</span>empty<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>]

        <span style="color:#75715e"># https://github.com/bokeh/bokeh/issues/1666</span>
        <span style="color:#66d9ef">for</span> k, p <span style="color:#f92672">in</span> [(<span style="color:#e6db74">&#34;recon&#34;</span>, p1), (<span style="color:#e6db74">&#34;target&#34;</span>, p2)]:
            self<span style="color:#f92672">.</span>renderers[<span style="color:#e6db74">&#34;train&#34;</span>][k] <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>image_rgba(image<span style="color:#f92672">=</span>[empty[::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]], x<span style="color:#f92672">=</span>[<span style="color:#ae81ff">0</span>], y<span style="color:#f92672">=</span>[<span style="color:#ae81ff">0</span>], dw<span style="color:#f92672">=</span>[<span style="color:#ae81ff">10</span>], dh<span style="color:#f92672">=</span>[r<span style="color:#f92672">*</span><span style="color:#ae81ff">10</span>])
        <span style="color:#66d9ef">for</span> k, p <span style="color:#f92672">in</span> [(<span style="color:#e6db74">&#34;recon&#34;</span>, p3), (<span style="color:#e6db74">&#34;target&#34;</span>, p4)]:
            self<span style="color:#f92672">.</span>renderers[<span style="color:#e6db74">&#34;test&#34;</span>][k] <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>image_rgba(image<span style="color:#f92672">=</span>[empty[::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]], x<span style="color:#f92672">=</span>[<span style="color:#ae81ff">0</span>], y<span style="color:#f92672">=</span>[<span style="color:#ae81ff">0</span>], dw<span style="color:#f92672">=</span>[<span style="color:#ae81ff">10</span>], dh<span style="color:#f92672">=</span>[r<span style="color:#f92672">*</span><span style="color:#ae81ff">10</span>])

        self<span style="color:#f92672">.</span>graph <span style="color:#f92672">=</span> gridplot([p1, p2, p3, p4], ncols<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, toolbar_location<span style="color:#f92672">=</span>toolbar_location)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_epoch_end</span>(self, epoch, phase, history):
        <span style="color:#66d9ef">for</span> k <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#34;recon&#34;</span>, <span style="color:#e6db74">&#34;target&#34;</span>]:
            self<span style="color:#f92672">.</span>renderers[phase][k]<span style="color:#f92672">.</span>data_source<span style="color:#f92672">.</span>data[<span style="color:#e6db74">&#34;image&#34;</span>] <span style="color:#f92672">=</span> [_to_img(history[phase][k][<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], self<span style="color:#f92672">.</span>cmap)[::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]]
        push_notebook()

        <span style="color:#66d9ef">if</span> save_img:
            bokeh<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>export_png(self<span style="color:#f92672">.</span>graph, <span style="color:#e6db74">&#34;fig/{:02d}_{}_image.png&#34;</span><span style="color:#f92672">.</span>format(epoch, self<span style="color:#f92672">.</span>cmap<span style="color:#f92672">.</span>name))</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># グレースケール</span>
callback <span style="color:#f92672">=</span> ImagePlotsCallback(cmap<span style="color:#f92672">=</span>cm<span style="color:#f92672">.</span>gray)
<span style="color:#66d9ef">if</span> show_static:
    <span style="color:#66d9ef">if</span> exists(<span style="color:#e6db74">&#34;fig/gray_image.gif&#34;</span>):
        <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;fig/gray_image.gif&#34;</span>, <span style="color:#e6db74">&#39;rb&#39;</span>) <span style="color:#66d9ef">as</span> f:
            IPython<span style="color:#f92672">.</span>display<span style="color:#f92672">.</span>display(Image(data<span style="color:#f92672">=</span>f<span style="color:#f92672">.</span>read()), format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;gif&#34;</span>)
<span style="color:#66d9ef">else</span>:
    bokeh<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>show(callback<span style="color:#f92672">.</span>graph, notebook_handle<span style="color:#f92672">=</span>True)</code></pre></div>
<p><img src="/images/jupyter_with_bokeh_files/jupyter_with_bokeh_38_0.png" alt="png" /></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># gifを作ったときに見やすいように、shuffle=Falseにする</span>
kwargs <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;num_workers&#39;</span>: <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;pin_memory&#39;</span>: True} <span style="color:#66d9ef">if</span> use_cuda <span style="color:#66d9ef">else</span> {}
train_loader <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>utils<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>DataLoader(
    datasets<span style="color:#f92672">.</span>MNIST(<span style="color:#e6db74">&#39;./data&#39;</span>, train<span style="color:#f92672">=</span>True, download<span style="color:#f92672">=</span>True,
                   transform<span style="color:#f92672">=</span>transforms<span style="color:#f92672">.</span>Compose([
                       transforms<span style="color:#f92672">.</span>ToTensor()
                   ])),
    batch_size<span style="color:#f92672">=</span>batch_size, shuffle<span style="color:#f92672">=</span>False, <span style="color:#f92672">**</span>kwargs)
test_loader <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>utils<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>DataLoader(
    datasets<span style="color:#f92672">.</span>MNIST(<span style="color:#e6db74">&#39;./data&#39;</span>, train<span style="color:#f92672">=</span>False, transform<span style="color:#f92672">=</span>transforms<span style="color:#f92672">.</span>Compose([
                       transforms<span style="color:#f92672">.</span>ToTensor(),
                   ])),
    batch_size<span style="color:#f92672">=</span>batch_size, shuffle<span style="color:#f92672">=</span>False, <span style="color:#f92672">**</span>kwargs)

data_loaders <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;train&#34;</span>: train_loader, <span style="color:#e6db74">&#34;test&#34;</span>:test_loader}</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">model <span style="color:#f92672">=</span> VAE()<span style="color:#f92672">.</span>cuda() <span style="color:#66d9ef">if</span> use_cuda <span style="color:#66d9ef">else</span> VAE()
optimizer <span style="color:#f92672">=</span> optim<span style="color:#f92672">.</span>Adam(model<span style="color:#f92672">.</span>parameters(), lr<span style="color:#f92672">=</span><span style="color:#ae81ff">1e-3</span>)
history <span style="color:#f92672">=</span> train_loop_vae(model, data_loaders, optimizer, epochs, callback<span style="color:#f92672">=</span>callback)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Test loss: {:.3f}&#34;</span><span style="color:#f92672">.</span>format(history[<span style="color:#e6db74">&#34;train&#34;</span>][<span style="color:#e6db74">&#34;loss&#34;</span>][<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]))</code></pre></div><pre><code>Test loss: 0.133</code></pre>
<p>本質的な違いはありませんが、異なるカラーマップを試してみます。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">gradient <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>linspace(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">256</span>)
gradient <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>vstack((gradient, gradient))
pyplot<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">16</span>,<span style="color:#ae81ff">0.5</span>))
imshow(gradient, aspect<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;auto&#34;</span>, cmap<span style="color:#f92672">=</span>cm<span style="color:#f92672">.</span>inferno)
axis(<span style="color:#e6db74">&#34;off&#34;</span>);</code></pre></div>
<p><img src="/images/jupyter_with_bokeh_files/jupyter_with_bokeh_42_0.png" alt="png" /></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">callback <span style="color:#f92672">=</span> ImagePlotsCallback(cmap<span style="color:#f92672">=</span>cm<span style="color:#f92672">.</span>inferno)
<span style="color:#66d9ef">if</span> show_static:
    <span style="color:#66d9ef">if</span> exists(<span style="color:#e6db74">&#34;fig/inferno_image.gif&#34;</span>):
        <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;fig/inferno_image.gif&#34;</span>, <span style="color:#e6db74">&#39;rb&#39;</span>) <span style="color:#66d9ef">as</span> f:
            IPython<span style="color:#f92672">.</span>display<span style="color:#f92672">.</span>display(Image(data<span style="color:#f92672">=</span>f<span style="color:#f92672">.</span>read()), format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;gif&#34;</span>)
<span style="color:#66d9ef">else</span>:
    bokeh<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>show(callback<span style="color:#f92672">.</span>graph, notebook_handle<span style="color:#f92672">=</span>True)</code></pre></div>
<p><img src="/images/jupyter_with_bokeh_files/jupyter_with_bokeh_43_0.png" alt="png" /></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">model <span style="color:#f92672">=</span> VAE()<span style="color:#f92672">.</span>cuda() <span style="color:#66d9ef">if</span> use_cuda <span style="color:#66d9ef">else</span> VAE()
optimizer <span style="color:#f92672">=</span> optim<span style="color:#f92672">.</span>Adam(model<span style="color:#f92672">.</span>parameters(), lr<span style="color:#f92672">=</span><span style="color:#ae81ff">1e-3</span>)
history <span style="color:#f92672">=</span> train_loop_vae(model, data_loaders, optimizer, epochs, callback<span style="color:#f92672">=</span>callback)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Test loss: {:.3f}&#34;</span><span style="color:#f92672">.</span>format(history[<span style="color:#e6db74">&#34;train&#34;</span>][<span style="color:#e6db74">&#34;loss&#34;</span>][<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]))</code></pre></div><pre><code>Test loss: 0.133</code></pre>
<h2 id="おわりに">おわりに</h2>

<p>Bokehによるグラフ作成は、少しとっつきにくいかもしれませんが（matplotlibとかではレンダラとか意識しないですよね）、慣れれば柔軟性が高く、便利なのではないかと思います。</p>

<p>今回の記事を書くにあたっては、bokeh v0.12.9 を使いました。もしローカルでnotebookを実行する場合は、バージョンを揃えることをおすすめします。</p>

<h2 id="参考">参考</h2>

<ul>
<li><a href="https://qiita.com/driller/items/0730325bf5c1cd689979">ipywidgetsとBokeh使ってインタラクティブな可視化をする - Qiita</a></li>
<li><a href="https://qiita.com/y__sama/items/654ed8ab7464718876f9">Jupyter Notebookを動的に使ってみる - Qiita</a></li>
<li><a href="https://bokeh.pydata.org/en/latest/">Welcome to Bokeh — Bokeh 0.12.12 documentation</a></li>
<li><a href="https://qiita.com/r9y9/items/d54162d37ec4f110f4b4">PyTorchで学習の過程を確認したいときはtensorboardXを使うのが良かったです -　Qiita</a></li>
</ul>

				
<div class="social">
    <div>
        <a href="https://twitter.com/share" class="twitter-share-button" data-via="r9y9" data-text="ニューラルネットの学習過程の可視化を題材に、Jupyter &#43; Bokeh で動的な描画を行う方法の紹介 [Jupyter Advent Calendar 2017]" data-related="r9y9">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    </div>
</div>


			</section>
		</article>
	</main>


	<footer role="contentinfo">
		<div class="hr"></div>
		<address>
			<div class="avatar-bottom">
				<a href="/">
					
					<img src="/images/r9y9.jpg">
					
				</a>
			</div>

		<div class="copyright">Copyright &copy;
			<a href="/about">Ryuichi YAMAMOTO</a> All rights reserved.

			<a href="https://github.com/r9y9">
				<span class="github">Github</span>
			</a>
		</div>
		</address>
	</footer>

</div>

<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-44433856-1', 'auto');
	ga('send', 'pageview');
</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



<script type="text/x-mathjax-config">
     MathJax.Hub.Config({
         HTML: ["input/TeX","output/HTML-CSS"],
         TeX: {
                Macros: {
                         bm: ["\\boldsymbol{#1}", 1],
                         argmax: ["\\mathop{\\rm arg\\,max}\\limits"],
                         argmin: ["\\mathop{\\rm arg\\,min}\\limits"]},
                extensions: ["AMSmath.js","AMSsymbols.js"],
                equationNumbers: { autoNumber: "AMS" } },
         extensions: ["tex2jax.js"],
         jax: ["input/TeX","output/HTML-CSS"],
         tex2jax: { inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                    displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
                    processEscapes: true },
         "HTML-CSS": { availableFonts: ["TeX"],
                       linebreaks: { automatic: true } }
     });
 </script>

 <script type="text/x-mathjax-config">
     MathJax.Hub.Config({
       tex2jax: {
         skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
       }
     });
 </script>

 <script type="text/javascript" async
   src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML">
 </script>




</body>
</html>

